# Quantum PCI FT - Руководство пользователя

## Установка и сборка

### Требования
- Go версии 1.18 или выше
- Git

### Сборка из исходного кода
```bash
# Клонирование репозитория
git clone https://github.com/opencomputeproject/quantum-pci-ft.git
cd quantum-pci-ft

# Загрузка зависимостей
go mod download

# Сборка программы
go build -o quantum-pci-ft

# Или установка в систему
go install
```

## Использование

### Базовый синтаксис
```bash
./quantum-pci-ft [опции]
```

### Опции командной строки

| Опция | Описание | Обязательная |
|-------|----------|--------------|
| `-input <файл>` | Путь к исходному бинарному файлу прошивки | ✓ |
| `-output <файл>` | Путь для сохранения прошивки с заголовком | ✓ (при использовании -apply) |
| `-vendor <число>` | PCI Vendor ID (например, 0x18d4) | ✓ (при использовании -apply) |
| `-device <число>` | PCI Device ID (например, 0x1008) | ✓ (при использовании -apply) |
| `-hw <число>` | Hardware Revision ID (по умолчанию: 0) | ✗ |
| `-apply` | Создать выходной файл с заголовком | ✗ |

### Примеры использования

#### 1. Анализ файла прошивки
Проверка файла без создания нового:
```bash
./quantum-pci-ft -input firmware.bin
```

#### 2. Добавление заголовка к прошивке
```bash
./quantum-pci-ft -input firmware.bin -output firmware_with_header.bin \
    -vendor 0x18d4 -device 0x1008 -apply
```

#### 3. Добавление заголовка с указанием ревизии оборудования
```bash
./quantum-pci-ft -input firmware.bin -output firmware_with_header.bin \
    -vendor 0x18d4 -device 0x1008 -hw 0x0002 -apply
```

## Формат заголовка

Заголовок добавляется в начало файла прошивки и занимает 16 байт:

| Поле | Размер | Описание |
|------|--------|----------|
| Магические байты | 4 байта | 'OCPC' - идентификатор формата |
| PCI Vendor ID | 2 байта | ID производителя устройства |
| PCI Device ID | 2 байта | ID модели устройства |
| Размер образа | 4 байта | Размер прошивки без заголовка |
| HW Revision | 2 байта | Ревизия оборудования |
| CRC16 | 2 байта | Контрольная сумма прошивки |

## Работа с различными производителями

### Celestica Time Card
```bash
./quantum-pci-ft -input TimeCardProduction.bin \
    -output TimeCardProduction_Celestica.bin \
    -vendor 0x18d4 -device 0x1008 -apply
```

### Orolia Time Card
```bash
./quantum-pci-ft -input TimeCardProduction.bin \
    -output TimeCardProduction_Orolia.bin \
    -vendor 0x1ad7 -device 0xa0c0 -apply
```

## Проверка результата

После создания файла с заголовком, вы можете проверить его:
```bash
./quantum-pci-ft -input firmware_with_header.bin
```

Программа покажет информацию о заголовке:
```
Quantum PCI FT - Инструмент для работы с прошивками PCI устройств
===========================================================

Входной файл уже содержит заголовок:
Информация о заголовке:
PCI Vendor ID: 0x18d4
PCI Device ID: 0x1008
PCI HW Revision ID: 0x0000
CRC16 образа: 0xa5b3
Размер образа: 1048576 байт
```

## Интеграция с devlink

Файлы прошивок с заголовком могут быть использованы с утилитой devlink для обновления прошивки устройств:

```bash
# Обновление прошивки через devlink
devlink dev flash pci/0000:04:00.0 file firmware_with_header.bin
```

Драйвер устройства проверит заголовок и убедится, что прошивка совместима с оборудованием перед началом процесса обновления.

## Решение проблем

### Ошибка "Не указан входной файл"
Убедитесь, что указали опцию `-input` с путем к файлу прошивки.

### Ошибка "Пустой или некорректный PCI Vendor ID"
PCI ID должны быть в диапазоне от 1 до 65535 (0xFFFF). Можно указывать в десятичном или шестнадцатеричном формате.

### Файл уже содержит заголовок
Программа предупредит, если входной файл уже содержит заголовок. При использовании флага `-apply` старый заголовок будет перезаписан.

## Контакты и поддержка

Проект является частью Open Compute Project. Для вопросов и предложений используйте систему Issues на GitHub.