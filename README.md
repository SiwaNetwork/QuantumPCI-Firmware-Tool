# Quantum PCI FT
Это простой инструмент для добавления заголовка к бинарному файлу прошивки. Заголовок используется драйвером для проверки совместимости оборудования с образом. Заголовок имеет длину всего 16 байт и содержит значения PCI Vendor ID, PCI Device ID и PCI Hardware Revision ID для проверки. Он также содержит значение CRC исходного образа. Причина добавления заголовка - убедиться, что несовместимая прошивка не будет случайно записана на устройство через devlink.

## Формат заголовка
| Магические байты | PCI Vendor ID | PCI Device ID | Размер образа | HW Rev ID | CRC16 |
| :----: | :----: | :----: | :----: | :----: | :----: |
| 4 байта | 2 байта | 2 байта | 4 байта | 2 байта | 2 байта |

Заголовок прошивки состоит из 6 полей, все значения в сетевом порядке байтов для обеспечения совместимости между архитектурами:

1. Магический заголовок (4 байта, 32 бита) - константное значение, 'OCTC' означает Open Compute Time Card
2. PCI Vendor ID (2 байта, 16 бит) - идентификатор производителя PCI устройства, совместимого с этим образом
3. PCI Device ID (2 байта, 16 бит) - идентификатор PCI устройства, совместимого с этим образом
4. Размер образа (4 байта, 32 бита, беззнаковое) - размер самой прошивки без заголовка (и подвала, если он есть)
5. HW Revision (2 байта, 16 бит) - информация, предоставляемая аппаратным регистром для различения ревизий одной и той же платы
6. CRC16 (2 байта, 16 бит) - контрольное значение реализации CRC16 с полиномом по умолчанию, реализованным в ядре


## Использование
Инструмент имеет несколько опций:
* `-input <имя_файла>` - Обязательная опция, указывает имя файла исходного бинарного файла.
* `-output <имя_файла>` - Обязательная опция, указывает имя файла для записи нового файла прошивки с заголовком. Если файл уже существует, он будет перезаписан.
* `-vendor <число>` - Обязательная опция, указывает PCI Vendor ID для добавления в заголовок.
* `-device <число>` - Обязательная опция, указывает PCI Device ID для добавления в заголовок.
* `-hw <число>` - Необязательная опция, используется для указания PCI Hardware Rev ID. По умолчанию 0.
* `-apply` - Необязательная опция. Используется для фактического создания нового (или перезаписи) выходного файла с заголовком в начале.

## Примеры
```
./quantum-pci-ft -input Time-Card/FPGA/Binary/Production/Binaries/TimeCardProduction.bin -output TimeCardProduction_Celestica.bin -vendor 0x18d4 -device 0x1008 -apply
```
Эта команда создаст `TimeCardProduction_Celestica.bin` с заголовком для timecard, произведенной Celestica.
